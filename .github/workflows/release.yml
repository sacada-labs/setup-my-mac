name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual triggering

jobs:
  build-and-release:
    runs-on: macos-latest
    permissions:
      contents: write  # Required to create releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build executable
        run: bun run build

      - name: Sign executable
        run: |
          # Sign with ad-hoc signature to help macOS Gatekeeper
          codesign --sign - --force --deep setup
          codesign --verify --verbose setup

      - name: Get version from tag
        id: get_version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi

      - name: Create checksum
        run: |
          shasum -a 256 setup > setup.sha256

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            setup
            setup.sha256
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## MacBook Setup TUI ${{ steps.get_version.outputs.version }}
            
            ### Installation
            
            1. Download `setup`
            2. Make executable: `chmod +x setup`
            3. Run: `xattr -d com.apple.quarantine setup && ./setup`
            
            ### Checksum
            
            Verify the download:
            `shasum -a 256 -c setup.sha256`
            